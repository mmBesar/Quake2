name: Build and Release Binaries (multiâ€‘arch)

on:
  push:
    branches: [ upstream ]
    tags: [ 'QUAKE2_*' ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [ amd64, arm64 ]
        suffix: [ linux-amd64, linux-arm64 ]
        platform: [ linux/amd64, linux/arm64 ]
    outputs:
      tag: ${{ env.TAG }}

    steps:
    - name: Checkout upstream
      uses: actions/checkout@v4
      with:
        ref: upstream
        fetch-depth: 0

    - name: Determine TAG
      id: tag
      run: |
        if [[ "${GITHUB_REF}" == refs/tags/QUAKE2_* ]]; then
          echo "TAG=${GITHUB_REF##*/}" >> $GITHUB_ENV
        else
          TAG=$(git tag --sort=-creatordate | grep '^QUAKE2_' | head -n1)
          echo "TAG=$TAG" >> $GITHUB_ENV
        fi

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3

    - name: Set up Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build source for ${{ matrix.arch }}
      run: |
        cmake -S . -B build-${{ matrix.arch }} \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_SYSTEM_NAME=Linux \
          -DCMAKE_SYSTEM_PROCESSOR=${{ matrix.arch }} \
          -B build-${{ matrix.arch }}

        cmake --build build-${{ matrix.arch }} --parallel

        mkdir -p output/${{ matrix.suffix }}
        cp build-${{ matrix.arch }}/quake2 output/${{ matrix.suffix }}/quake2
        cp build-${{ matrix.arch }}/q2ded  output/${{ matrix.suffix }}/q2ded
        cp build-${{ matrix.arch }}/ref_*.so output/${{ matrix.suffix }}/ || true
        mkdir -p output/${{ matrix.suffix }}/baseq2
        cp build-${{ matrix.arch }}/baseq2/game.so output/${{ matrix.suffix }}/baseq2/ || true

        cp -r output/${{ matrix.suffix }} output/${{ matrix.suffix }}-debug
        cd output/${{ matrix.suffix }}-debug
        strip quake2 q2ded ref_*.so || true
        cd ../..

        # Create zip artifacts
        cd output
        zip -r quake2-${{ matrix.suffix }}-${TAG}.zip "${{ matrix.suffix }}"
        zip -r quake2-${{ matrix.suffix }}-${TAG}-debug.zip "${{ matrix.suffix }}-debug"
        cd ..

    - name: Upload release assets
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ env.TAG }}
        name: ${{ env.TAG }}
        files: |
          output/quake2-${{ matrix.suffix }}-${{ env.TAG }}.zip
          output/quake2-${{ matrix.suffix }}-${{ env.TAG }}-debug.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
